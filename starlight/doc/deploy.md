# Deploying Starlight

## Environment Variables

Starlight aims at following the [12 factor application][12-factor] pattern as much as
possible. To that end, there are a set of environment variables that one should
populate when deploying to a staging/production server. Development and test
instances have sane defaults that you should not need to adjust unless you want
to.

How you make these environment variables available during deployment and
application runtime is up to you. You could use an Ansible playbook, Chef,
Puppet, or whatever works best in your local environment and practices.

### Runtime Variables

| Name | Description | Required |
| ---- | ----------- | -------- |
| `AUTH_METHOD` | `google`, `developer`, or `database` | Yes |
| `BINARY_ROOT` | Mounted share for local file ingestion | No |
| `DATABASE_URL` | Setup your [database connection information][db] | Yes |
| `FROM_EMAIL` | Application email address to use with ActionMailer | Yes |
| `GA_EMAIL` | see [Google Analytics section in README][ga] | No |
| `GA_PKCS12_KEY_PATH` | see [Google Analytics section in README][ga] | No |
| `GA_WEB_PROPERTY_ID` | see [Google Analytics section in README][ga] | No |
| `HOSTNAME` | Hostname to use for ActionMailer | Yes |
| `PORT` | Application port. Generally `3000` for Rails applications | No |
| `PROJECT_PATH` | Location that the application is deployed on the server. E.g. `/opt/starlight` | Yes |
| `RAILS_LOG_TO_STDOUT` | Set to any string value if you need to log to stdout | No |
| `RAILS_MAX_THREADS` | Maximum size of the database connection pool. Note this is also used by [sidekiq][sidekiq-threads] to set threads per process. | Yes |
| `RAILS_QUEUE` | For `production` like environments, use `sidekiq` | Yes |
| `REDIS_URL` | URL of your REDIS instance. E.g. `redis://localhost:6379` | Yes |
| `SECRET_KEY_BASE` | Can be generated by Ansible scripts. | Yes |
| `SITEMAP_DEFAULT_HOST` | Hostname for production application. E.g. `http://localhost` | Yes |
| `SMTP_HOST` | SMPT host for use with ActionMailer. E.g `localhost` | Yes |
| `SOLR_URL` | URL of your Solr instance. E.g `http://solr:8983/solr/starlight-core` | Yes |
| `SPOTLIGHT_THEMES` | Comma-separated, used by Spotlight to activate custom themes. E.g. `ucsb,ucsd,surfliner` | No |

### Deploy Variables

Set these locally when deploying with Capistrano:

| Name | Description | Required |
| ---- | ----------- | -------- |
| `CAP_KEYFILE` | Path to ssh key for Capistrano; defaults to `~/.ssh/id_rsa` | No |
| `CAP_PROXY` | Proxy settings to use during deploy | No |
| `CAP_REVISION` | Git branch or commit to deploy; defaults to `master` | No |
| `CAP_SERVER` | Server for Capistrano to deploy the application | Yes |
| `CAP_SITEMAP_REFRESH` | Set this to any value to refresh sitemaps on deploy | No |
| `CAP_TARGET` | Path for Capistrano to place your application; defaults to `/opt/starlight` | No |
| `CAP_USER` | User for Capistrano to use during deployment | Yes |

[12-factor]: https://12factor.net/
[db]: https://edgeguides.rubyonrails.org/configuring.html#configuring-a-database
[ga]: ../README.md#google-analytics
[sidekiq-threads]:https://github.com/mperham/sidekiq/issues/2985

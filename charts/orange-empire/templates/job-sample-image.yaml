{{- if .Values.cantaloupe.s3.sampleData }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "orange-empire.fullname" . }}-sample-image
  labels:
    {{- include "orange-empire.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      name: {{ include "orange-empire.fullname" . }}-sample-image
    spec:
      restartPolicy: Never
      serviceAccountName: {{ template "orange-empire.serviceAccountName" . }}
      containers:
        - name: surfliner-util-sample-image
          image: "{{ .Values.util.image.repository }}:{{ .Values.util.image.tag }}"
          imagePullPolicy: "{{ .Values.util.image.pullPolicy }}"
          command:
            - sh
            - -c
            - >
              export AWS_ACCESS_KEY_ID="$CANTALOUPE_S3SOURCE_ACCESS_KEY_ID";
              export AWS_SECRET_ACCESS_KEY="$CANTALOUPE_S3SOURCE_SECRET_KEY";
              apk add --no-cache curl;
              curl -L -v "$SAMPLE_IMAGE_URL" -o /tmp/puppies.jpg;
{{- if .Values.cantaloupe.delegate.enabled }}
              aws --endpoint-url "$CANTALOUPE_S3SOURCE_ENDPOINT" s3 cp /tmp/puppies.jpg s3://$CANTALOUPE_S3SOURCE_BUCKET_NAME/puppies.jpg
{{- else }}
              aws --endpoint-url "$CANTALOUPE_S3SOURCE_ENDPOINT" s3 cp /tmp/puppies.jpg s3://$CANTALOUPE_S3SOURCE_BASICLOOKUPSTRATEGY_BUCKET_NAME/puppies.jpg
{{- end }}
          envFrom:
            - configMapRef:
                name: {{ include "orange-empire.fullname" . }}-env
            - secretRef:
                name: {{ template "orange-empire.secretName" . }}
          env:
            - name: SAMPLE_IMAGE_URL
              value: https://gitlab.com/surfliner/surfliner/-/raw/trunk/comet/spec/fixtures/image.jpg
{{- end }}

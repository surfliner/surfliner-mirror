{{- if .Values.cantaloupe.s3.sampleData }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "orange-empire.fullname" . }}-sample-image
  labels:
    {{- include "orange-empire.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      name: {{ include "orange-empire.fullname" . }}-sample-image
    spec:
      restartPolicy: Never
      serviceAccountName: {{ template "orange-empire.serviceAccountName" . }}
      containers:
        - name: sample-image
          image: d3fk/s3cmd:latest
          imagePullPolicy: Always
          command:
            - sh
            - -c
            - >
              apk add --no-cache curl &&
              curl -L 'https://gitlab.com/surfliner/surfliner/-/raw/trunk/comet/spec/fixtures/image.jpg' -o puppies.jpg &&
              s3cmd --no-ssl \
                    --access_key $CANTALOUPE_S3SOURCE_ACCESS_KEY_ID \
                    --secret_key $CANTALOUPE_S3SOURCE_SECRET_KEY \
                    --host $CANTALOUPE_S3SOURCE_ENDPOINT \
                    {{ if .Values.minio.enabled }}--host-bucket $CANTALOUPE_S3SOURCE_ENDPOINT{{ end }} \
                    put puppies.jpg s3://$CANTALOUPE_S3SOURCE_BASICLOOKUPSTRATEGY_BUCKET_NAME/puppies.jpg
          envFrom:
            - configMapRef:
                name: {{ include "orange-empire.fullname" . }}-env
            - secretRef:
                name: {{ template "orange-empire.secretName" . }}
{{- end }}

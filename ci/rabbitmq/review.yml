.rabbitmq:deploy:review:
  stage: review
  needs: []
  extends:
    - .helm3-deploy
  variables:
    HELM_RELEASE_NAME: rabbitmq-cluster-operator
    KUBE_NAMESPACE: rabbitmq-system
  rules:
    - !reference [.rabbitmq-mr-rules, rules]

rabbitmq:deploy:ucsd-review:
  extends:
    - .rabbitmq:deploy:review
    - .rabbitmq-chart-deploy
  environment:
    name: ucsd.rabbitmq.review/$CI_MERGE_REQUEST_ID
    url: http://rabbitmq-$CI_MERGE_REQUEST_ID.$UCSD_REVIEW_DOMAIN
    on_stop: rabbitmq:cleanup:ucsd-review
    auto_stop_in: 2 days
  tags:
    - ucsd
  variables:
    HELM_UPGRADE_EXTRA_ARGS: >
      --set clusterOperator.image.tag=1.14.0-scratch-r8
      --set clusterOperator.extraEnvVarsSecret=rabbitmq-credentials
    KUBE_ROLE_CONFIG: $KUBE_ROLE_CONFIG_UCSD_REVIEW

rabbitmq:deploy:ucsb-review:
  extends:
    - .rabbitmq:deploy:review
    - .rabbitmq-chart-deploy
  environment:
    name: ucsb.rabbitmq.review/$CI_MERGE_REQUEST_ID
    url: http://rabbitmq-$CI_MERGE_REQUEST_ID.$UCSB_REVIEW_DOMAIN
    on_stop: rabbitmq:cleanup:ucsb-review
    auto_stop_in: 2 days
  tags:
    - ucsd
  variables:
    HELM_UPGRADE_EXTRA_ARGS: >
      --set clusterOperator.image.tag=1.14.0-scratch-r8
      --set clusterOperator.extraEnvVarsSecret=rabbitmq-credentials

rabbitmq:cleanup:ucsd-review:
  extends:
    - .rabbitmq:deploy:review
  environment:
    name: ucsd.rabbitmq.review/$CI_MERGE_REQUEST_ID
    url: http://rabbitmq-$CI_MERGE_REQUEST_ID.$UCSD_REVIEW_DOMAIN
    action: stop
  tags:
    - ucsd
  when: manual
  allow_failure: true
  variables:
    GIT_STRATEGY: none
    KUBE_ROLE_CONFIG: $KUBE_ROLE_CONFIG_UCSD_REVIEW
  script:
    - delete
    - delete_stateful_set_pvcs

rabbitmq:cleanup:ucsb-review:
  extends:
    - .rabbitmq:deploy:review
  environment:
    name: ucsb.rabbitmq.review/$CI_MERGE_REQUEST_ID
    url: http://rabbitmq-$CI_MERGE_REQUEST_ID.$UCSB_REVIEW_DOMAIN
    action: stop
  tags:
    - ucsb
  when: manual
  allow_failure: true
  variables:
    GIT_STRATEGY: none
  script:
    - delete
    - delete_stateful_set_pvcs
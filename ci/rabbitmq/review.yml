.rabbitmq:deploy:review:
  stage: review
  needs: []
  extends:
    - .helm3-deploy
  variables:
    HELM_RELEASE_NAME: rabbitmq-cluster-operator
    KUBE_NAMESPACE: rabbitmq-system
  rules:
    - !reference [.rabbitmq-mr-rules, rules]

rabbitmq:deploy:ucsd-review:
  extends:
    - .rabbitmq:deploy:review
    - .rabbitmq-chart-deploy
  environment:
    name: ucsd.rabbitmq.review/$CI_MERGE_REQUEST_ID
    url: http://rabbitmq-$CI_MERGE_REQUEST_ID.$UCSD_REVIEW_DOMAIN
    on_stop: rabbitmq:cleanup:ucsd-review
    auto_stop_in: 2 days
  tags:
    - ucsd
  variables:
    HELM_UPGRADE_EXTRA_ARGS: >
      --set clusterOperator.image.tag=1.14.0-scratch-r8
      --set clusterOperator.extraEnvVarsSecret=comet-review-rabbitmq
    KUBE_ROLE_CONFIG: $KUBE_ROLE_CONFIG_UCSD_REVIEW

rabbitmq:cleanup:ucsd-review:
  extends:
    - .rabbitmq:deploy:review
  environment:
    name: ucsd.rabbitmq.review/$CI_MERGE_REQUEST_ID
    url: http://rabbitmq-$CI_MERGE_REQUEST_ID.$UCSD_REVIEW_DOMAIN
    action: stop
  tags:
    - ucsd
  when: manual
  allow_failure: true
  variables:
    GIT_STRATEGY: none
    KUBE_ROLE_CONFIG: $KUBE_ROLE_CONFIG_UCSD_REVIEW
  script:
    - delete
    - delete_stateful_set_pvcs

# rabbitmq:deploy:ucsb-review:
#   extends:
#     - .helm3-deploy
#     - .rabbitmq:deploy:review
#     - .rabbitmq-chart-deploy
#   environment:
#     name: ucsb.review.rabbitmq
#     url: http://rabbitmq-$CI_MERGE_REQUEST_ID.$KUBE_INGRESS_BASE_DOMAIN
#     on_stop: rabbitmq:cleanup:ucsb-review
#     auto_stop_in: 4 days
#   variables:
#     HELM_ENCODED_VALUES: $UCSB_REVIEW_SOLR_VALUES
#     HELM_UPGRADE_EXTRA_ARGS: >
#       --set ingress.hosts[0].host=rabbitmq-$CI_MERGE_REQUEST_ID.$KUBE_INGRESS_BASE_DOMAIN
#       --set ingress.hosts[0].paths[0].path='/'
#       --set ingress.tls[0].hosts[0]=rabbitmq-$CI_MERGE_REQUEST_ID.$KUBE_INGRESS_BASE_DOMAIN
#       --set ingress.tls[0].secretName=tls-secret
#       --set worker.image.repository=$CI_REGISTRY_IMAGE/rabbitmq_worker_web
#       --set worker.image.tag=$CI_COMMIT_SHA
#       --set dbPreSetupInitContainer[0].envFrom[0].configMapRef.name=surfliner-rabbitmq-$CI_MERGE_REQUEST_ID-hyrax-env
#       --set dbPreSetupInitContainer[0].envFrom[1].secretRef.name=surfliner-rabbitmq-$CI_MERGE_REQUEST_ID-hyrax
#       --set solrPreSetupInitContainer[0].image=$CI_REGISTRY_IMAGE/rabbitmq_worker_web:$CI_COMMIT_SHA
#       --set solrPreSetupInitContainer[0].envFrom[0].configMapRef.name=surfliner-rabbitmq-$CI_MERGE_REQUEST_ID-hyrax-env
#       --set solrPreSetupInitContainer[0].envFrom[1].secretRef.name=surfliner-rabbitmq-$CI_MERGE_REQUEST_ID-hyrax
#       --set extraEnvVars[4].value=surfliner.metadata.publish.$CI_MERGE_REQUEST_ID
#       --set worker.extraEnvVars[4].value=surfliner.metadata.publish.$CI_MERGE_REQUEST_ID
#       --values charts/snippets/surfliner/solr-review.yaml
#       --values charts/snippets/rabbitmq/solr-setup.yaml
#       --values charts/snippets/rabbitmq/init-containers.yaml
#       --values charts/snippets/rabbitmq/review-limit-defaults.yaml
#       --values charts/snippets/rabbitmq/review-deploy.yaml
#       --values charts/snippets/rabbitmq/ucsb-review-deploy.yaml

# rabbitmq:cleanup:ucsb-review:
#   extends:
#     - .helm3-deploy
#     - .rabbitmq:deploy:review
#   environment:
#     name: ucsb.review.rabbitmq
#     action: stop
#   when: manual
#   allow_failure: true
#   variables:
#     GIT_STRATEGY: none
#   script:
#     - delete
#     - delete_stateful_set_pvcs

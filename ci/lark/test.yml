lark:test:solrconfig:
  image: alpine:3.16.0
  stage: test
  needs: []
  extends:
    - .only-refs-default
    - .only-lark-changes
  script:
    - tar -zcf lark-solr-config.tar.gz lark/solr
  artifacts:
    untracked: false
    expire_in: 1 day
    paths:
      - lark-solr-config.tar.gz

lark:api:test:unit:
  stage: test
  image: $CI_REGISTRY_IMAGE/lark_web:$CI_COMMIT_SHA
  needs: ["lark:test:solrconfig", "lark:ruby-build"]
  variables:
    POSTGRES_ADMIN_PASSWORD: password
    POSTGRES_DB: postgres
    POSTGRES_HOST: postgres
    POSTGRES_PASSWORD: password
    POSTGRES_PORT: 5432
    POSTGRES_USER: postgres
    REPOSITORY_URL: $CI_REPOSITORY_URL
    SOLR_CORES: lark-test
    SOLR_CORE_CONF_DIR: "/tmp/lark/solr/config"
    SOLR_HOST: solr
    SOLR_PORT: 8983
    SOLR_URL: "http://solr:8983/solr/lark-test"
  services:
    - name: bitnami/postgresql:12.10.0-debian-10-r75
      alias: postgres
    - name: bitnami/solr:8.11.2-debian-11-r6
      alias: solr
      variables:
        JQ_VERSION: "jq-1.6"
      entrypoint: [""]
      command:
        - /bin/sh
        - -c
        - >-
          curl -s -L --output /tmp/jq "https://github.com/stedolan/jq/releases/download/$JQ_VERSION/jq-linux64";
          chmod +x /tmp/jq;
          job_id=$(curl -s --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs?scope[]=success" | /tmp/jq '.[] | select(.name == "lark:test:solrconfig").id');
          curl -s --location --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/jobs/${job_id}/artifacts/lark-solr-config.tar.gz" | tar -xzv -C /tmp;
          /opt/bitnami/scripts/solr/entrypoint.sh /opt/bitnami/scripts/solr/run.sh;
  script:
    - cd lark
    - bundle check || bundle
    - solr-core-wait.sh
    - db-wait.sh "${POSTGRES_HOST}:${POSTGRES_PORT}" bundle exec rake db:migrate
    - bundle exec rspec
  extends:
    - .only-refs-default
    - .only-lark-api-changes
  tags:
    - kubernetes

lark:client:test:unit:
  stage: test
  needs: ["lark:ruby-build"]
  image: $CI_REGISTRY_IMAGE/lark_web:$CI_COMMIT_SHA
  script:
    - cd lark-client
    - bundle check || bundle
    - bundle exec rspec --tag ~integration
  extends:
    - .only-refs-default
    - .only-lark-cli-changes
  only:
    changes:
      - .gitlab-ci.yml
      - ci/lark/**/*
      - lark-client/**/*

lark:ui:test:unit:
  stage: test
  needs: ["lark:ui:ruby-build"]
  image: $CI_REGISTRY_IMAGE/lark-ui_web:$CI_COMMIT_SHA
  script:
    - apk add build-base # need to build gem extensions and compile assets
    - bundle config set without 'development' # to get test group gems back
    - cd lark-ui
    - bundle check || bundle
    - bundle exec rspec
  extends:
    - .only-refs-default
  only:
    changes:
      - .gitlab-ci.yml
      - ci/lark/**/*
      - lark-ui/**/*

lark:client:test:integration:
  stage: integration
  needs: ["lark:ruby-build"]
  image: $CI_REGISTRY_IMAGE/lark_web:$CI_COMMIT_SHA
  script:
    - cd lark-client
    - bundle check || bundle
    - bundle exec rspec --tag @integration
  extends:
    - .only-refs-default
    - .only-lark-changes

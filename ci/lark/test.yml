lark-unit-tests:
  stage: test
  image: $CI_REGISTRY_IMAGE/lark_web:$CI_COMMIT_REF_NAME
  variables:
    SOLR_CORE_NAME: lark-test
    SOLR_CONFIG_DIR: lark/solr/config
    REPOSITORY_URL: $CI_REPOSITORY_URL
    SOLR_CONFIG_COMMIT_SHA: $CI_COMMIT_SHA
    POSTGRES_DB: postgres
    POSTGRES_USER: runner
    POSTGRES_PASSWORD: ""
    POSTGRES_HOST: postgres
    POSTGRES_PORT: 5432
  services:
    - name: $CI_REGISTRY_IMAGE/solr
      alias: solr
    - postgres:latest
  script:
    - cd lark
    - bundle check || bundle
    - rake db:create db:migrate && bundle exec rspec
  extends: .only-refs-default
  only:
    changes:
      - .gitlab-ci.yml
      - ci/lark/**/*
      - lark/**/*

lark-client-unit:
  stage: test
  # reuse the lark_web image; ruby alpine images are missing system dependencies
  image: $CI_REGISTRY_IMAGE/lark_web:$CI_COMMIT_REF_NAME
  script:
    - cd lark-client
    - bundle check || bundle
    - bundle exec rspec --tag ~integration
  extends: .only-refs-default
  only:
    changes:
      - .gitlab-ci.yml
      - ci/lark/**/*
      - lark-client/**/*

lark-client-integration:
  stage: integration
  # reuse the lark_web image; ruby alpine images are missing system dependencies
  image: $CI_REGISTRY_IMAGE/lark_web:$CI_COMMIT_REF_NAME
  script:
    - cd lark-client
    - bundle check || bundle
    - bundle exec rspec --tag @integration
  extends: .only-refs-default
  only:
    changes:
      - .gitlab-ci.yml
      - ci/lark/**/*
      - lark-client/**/*
      - lark/**/*

lark:api:test:unit:
  stage: test
  image: $CI_REGISTRY_IMAGE/lark_web:$CI_COMMIT_SHA
  needs: ["lark:ruby-build"]
  variables:
    SOLR_CORE_NAME: lark-test
    SOLR_CONFIG_DIR: lark/solr/config
    SOLR_URL: http://localhost:8983/solr/lark-test
    REPOSITORY_URL: $CI_REPOSITORY_URL
    SOLR_CONFIG_COMMIT_SHA: $CI_COMMIT_SHA
    SOLR_HOST: localhost
    POSTGRES_DB: postgres
    POSTGRES_USER: runner
    POSTGRES_PASSWORD: password
    POSTGRES_HOST: localhost
    POSTGRES_PORT: 5432
  services:
    - name: $CI_REGISTRY_IMAGE/solr
      alias: solr
    - name: postgres:latest
      alias: db
  script:
    - cd lark
    - bundle check || bundle
    - rake db:create db:migrate && bundle exec rspec
  extends:
    - .only-refs-default
    - .only-lark-api-changes
  tags:
    - kubernetes

lark:client:test:unit:
  stage: test
  needs: ["lark:ruby-build"]
  image: $CI_REGISTRY_IMAGE/lark_web:$CI_COMMIT_SHA
  script:
    - cd lark-client
    - bundle check || bundle
    - bundle exec rspec --tag ~integration
  extends:
    - .only-refs-default
    - .only-lark-cli-changes
  only:
    changes:
      - .gitlab-ci.yml
      - ci/lark/**/*
      - lark-client/**/*

lark:client:test:integration:
  stage: integration
  needs: ["lark:ruby-build"]
  image: $CI_REGISTRY_IMAGE/lark_web:$CI_COMMIT_SHA
  script:
    - cd lark-client
    - bundle check || bundle
    - bundle exec rspec --tag @integration
  extends:
    - .only-refs-default
    - .only-lark-changes

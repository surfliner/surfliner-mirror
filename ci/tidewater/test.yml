tidewater:test:
  stage: test
  image: $CI_REGISTRY_IMAGE/tidewater_web:$CI_COMMIT_SHA
  needs: ["tidewater:build"]
  variables:
    OAI_ADMIN_EMAIL: tidewater@example.com
    OAI_METADATA_PROFILE: tag:surfliner.github.io,2022:api/oai_dc
    OAI_NAMESPACE_IDENTIFIER: test
    OAI_REPOSITORY_NAME: tidewater
    OAI_REPOSITORY_ORIGIN: http://localhost:3000
    OAI_SAMPLE_ID: 13900
    POSTGRES_ADMIN_PASSWORD: password
    POSTGRES_DB: tidewater-test
    POSTGRES_DB_TEST: tidewater-test
    POSTGRES_HOST: localhost
    POSTGRES_PASSWORD: password
    POSTGRES_PORT: 5432
    POSTGRES_USER: postgres
    RAILS_ENV: test
  services:
    - name: bitnami/postgresql:12.10.0-debian-10-r26
      alias: postgres
  script:
    - cd tidewater
    - bundle exec rake db:create db:migrate
    - bundle exec rspec
  rules:
    - !reference [.tidewater-mr-rules, rules]
    - !reference [.tidewater-default-branch-rules, rules]
  tags:
    - kubernetes

include:
  - local: ci/comet/build.yml
  - local: ci/comet/lint.yml
  - local: ci/comet/test.yml
  - local: ci/comet/review.yml
  - local: ci/comet/staging.yml
  - local: ci/comet/production.yml

.only-comet-changes:
  only:
    changes:
      - .gitlab-ci.yml
      - charts/comet/**/*
      - charts/snippets/comet/*
      - charts/snippets/surfliner/*
      - ci/comet/**/*
      - ci/comet.yml
      - comet/**/*
      - comet/Dockerfile
      - gems/surfliner_schema/**/*

.rabbitmq_helpers: &rabbitmq_helpers |
  create_rabbitmq_queue() {
    if kubectl --kubeconfig $KUBECONFIG get rabbitmqclusters.rabbitmq.com/$RABBITMQ_RELEASE_NAME -n $KUBE_NAMESPACE; then
      echo "RABBITMQ QUEUE EXISTS $RABBITMQ_RELEASE_NAME"
      return 0
    fi
    echo "CREATING RABBITMQ QUEUE $RABBITMQ_RELEASE_NAME"
    sed "s/NAME/$RABBITMQ_RELEASE_NAME/" util/rabbitmq-instance.yml |\
    kubectl --kubeconfig $KUBECONFIG -n $KUBE_NAMESPACE apply -f -
  }

.comet-chart-deploy:
  script:
    - *rabbitmq_helpers
    - create_rabbitmq_queue
    - helm pull oci://ghcr.io/samvera/charts/hyrax --version 1.1.0 --untar --untardir charts
    - deploy ./charts/hyrax


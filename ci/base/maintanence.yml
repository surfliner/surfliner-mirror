rebuild-base:
  stage: maintanence
  services:
    - name: docker:$DOCKER_IMAGE_VERSION-dind
  script:
    - registry_login
    - cd docker/base
    - docker build -t $CI_REGISTRY_IMAGE/builder .
    - docker push $CI_REGISTRY_IMAGE/builder
  when: manual

rebuild-buildah:
  image: registry.fedoraproject.org/fedora-minimal:30
  stage: maintanence
  script:
    - microdnf install -y buildah
    - buildah login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - cd docker/buildah
    - buildah bud --format docker --storage-driver vfs -t $CI_REGISTRY_IMAGE/buildah .
    - buildah push --storage-driver vfs docker://$CI_REGISTRY_IMAGE/buildah
  when: manual

rebuild-solr:
  image: $CI_REGISTRY_IMAGE/buildah
  stage: maintanence
  script:
    - buildah login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - cd docker/solr
    - buildah bud --format docker --storage-driver vfs -t $CI_REGISTRY_IMAGE/solr .
    - buildah push --storage-driver vfs docker://$CI_REGISTRY_IMAGE/solr
  when: manual

prune-tags:
  stage: maintanence
  image: alpine
  script:
    - apk --no-cache upgrade && apk add --no-cache curl git jq
    - sh ci/base/prune_tags
  only:
    - schedules



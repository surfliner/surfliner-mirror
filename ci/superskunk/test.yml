superskunk:test:
  stage: test
  image: $CI_REGISTRY_IMAGE/superskunk:$CI_COMMIT_SHA
  needs: ["superskunk:build"]
  variables:
    DB_HOST: postgres
    DB_NAME: comet_metadata_development
    DB_PASSWORD: postgres
    DB_PORT: 5432
    DB_USERNAME: postgres
    METADATA_DATABASE_NAME: comet_metadata_development
    METADATA_MODELS: "ucsb-metadata"
    POSTGRES_ADMIN_PASSWORD: password
    POSTGRES_DB: "skunk-test"
    POSTGRES_HOST: postgres
    POSTGRES_PASSWORD: "postgres"
    POSTGRES_PORT: 5432
    POSTGRES_USER: "postgres"
    RAILS_ENV: test
  services:
    - name: bitnami/postgresql:12.12.0
      alias: postgres
  script:
    - cd superskunk
    - cp -r /home/superskunk/db db
    - cp -r /home/superskunk/config/metadata config/metadata
    - cd scripts
    - db-migrate-seed.sh
    - cd ..
    - bundle exec rspec
  rules:
    - !reference [.superskunk-mr-rules, rules]
    - !reference [.superskunk-default-branch-rules, rules]
  tags:
    - kubernetes

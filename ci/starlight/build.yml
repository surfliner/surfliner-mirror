.starlight_builder: &starlight_builder |
  set -x
  build_starlight() {
    image_name=$1
    target=$2

    destination="--destination $CI_REGISTRY_IMAGE/$image_name:$CI_COMMIT_SHA"
    if [ "$CI_COMMIT_BRANCH" = "trunk" ]; then
      destination="$destination --destination $CI_REGISTRY_IMAGE/$image_name:stable"
    elif [ "$CI_COMMIT_TAG" ]; then
      destination="$destination --destination $CI_REGISTRY_IMAGE/$image_name:$CI_COMMIT_TAG"
    fi

    /kaniko/executor --context "$CI_PROJECT_DIR" --cache=true --push-retry 3 --target "$target" --dockerfile "$CI_PROJECT_DIR"/starlight/Dockerfile $destination --build-arg LOCAL_PROJECT=starlight --build-arg BUILD_TIME_APKS="$APKS"
  }

.starlight:build:
  extends:
    - .kaniko-build
  needs: ["shared:ruby-base"]
  variables:
    APKS: "build-base gcompat git libxml2-dev libxslt-dev nodejs postgresql-dev shared-mime-info tzdata yarn"
  before_script:
    - *starlight_builder
  rules:
    - !reference [.starlight-mr-rules, rules]
    - !reference [.starlight-default-branch-rules, rules]

starlight:build:prod:
  extends:
    - .starlight:build
  script:
    - build_starlight "starlight_web" "starlight-prod"

starlight:build:test:
  extends:
    - .starlight:build
  script:
    - build_starlight "starlight_test" "starlight-dev"

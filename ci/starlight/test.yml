.starlight:test:
  image: $CI_REGISTRY_IMAGE/starlight_web:$CI_COMMIT_SHA
  needs: ["starlight:build"]
  stage: test
  extends:
    - .only-refs-default
    - .only-starlight-changes
  variables:
    DB_ADAPTER: "postgresql"
    DELIVERY_METHOD: "test"
    POSTGRESQL_DATABASE: "starlight-test"
    POSTGRES_HOST: "localhost"
    POSTGRES_PASSWORD: "postgres"
    POSTGRES_USER: "postgres"
    RAILS_ENV: test
    RAILS_QUEUE: inline
    REPOSITORY_URL: $CI_REPOSITORY_URL
    S3_BUCKET_NAME: ""
    SELENIUM_URL: "http://localhost:4444/wd/hub/"
    SOLR_CONFIG_COMMIT_SHA: $CI_COMMIT_SHA
    SOLR_CORE_NAME: "starlight-test"
    SOLR_HOST: solr
    SOLR_PORT: 8983
    SOLR_URL: "http://solr:8983/solr/starlight-test"
    START_XVFB: "false"
    TEST_POSTGRES_DB: "starlight-test"
    ZK_HOST: zk
    ZK_PORT: 2181
  services:
    - name: bitnami/postgresql:12.10.0-debian-10-r32
      alias: postgres
    - name: seleniarm/standalone-chromium:4.1.3-20220409
      alias: chrome
    - name: solr:8.11.1
      alias: solr
    - name: zookeeper:3.7
      alias: zk
  before_script:
    - cd /home/starlight/app
    - SKIP_TRANSLATION=yes upload-solr-configs.sh /home/starlight/app/solr/config
    - SKIP_TRANSLATION=yes create-solr-collection.sh
    - SKIP_TRANSLATION=yes bundle exec rake db:migrate
  tags:
    - kubernetes

starlight:test:system:
  extends: .starlight:test
  script:
    - bundle exec rspec --tag type:system --format progress --format RspecJunitFormatter --out rspec.xml
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    reports:
      junit: starlight/rspec.xml
    when: on_failure
    paths:
      - starlight/tmp/screenshots

starlight:test:unit:
  extends: .starlight:test
  script:
    - bundle exec rspec --tag ~type:system --format progress --format RspecJunitFormatter --out rspec.xml
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    reports:
      junit: starlight/rspec.xml
    when: on_failure

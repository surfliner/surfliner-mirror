starlight-system-test:
  image: $CI_REGISTRY_IMAGE/starlight_web:$CI_COMMIT_REF_NAME
  stage: test
  variables:
    DATABASE_URL: "postgres://postgres@postgres/starlight-test"
    DATABASE_COMMAND: "db:create db:schema:load"
    SOLR_CORE_NAME: "starlight-test"
    SOLR_CONFIG_DIR: "starlight/solr/config"
    SOLR_CONFIG_COMMIT_SHA: $CI_COMMIT_SHA
    SOLR_URL: "http://solr:8983/solr/starlight-test"
    REPOSITORY_URL: $CI_REPOSITORY_URL
    SELENIUM_URL: "http://chrome:4444/wd/hub/"
    RAILS_ENV: "test"
    START_XVFB: "false"
  services:
    - name: $CI_REGISTRY_IMAGE/solr
      alias: solr
    - name: selenium/standalone-chrome:latest
      alias: chrome
    - postgres:11-alpine
  script:
    - cd starlight
    - RAILS_ENV=test bundle exec rspec --tag type:system --format progress --format RspecJunitFormatter --out rspec.xml
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    reports:
      junit: starlight/rspec.xml
    when: on_failure
    paths:
      - starlight/tmp/screenshots
  extends: .only-refs-default
  only:
    changes:
      - .gitlab-ci.yml
      - ci/starlight/**/*
      - starlight/**/*

starlight-unit-test:
  image: $CI_REGISTRY_IMAGE/starlight_web:$CI_COMMIT_REF_NAME
  stage: test
  variables:
    DATABASE_URL: "postgres://postgres@postgres/starlight-test"
    DATABASE_COMMAND: "db:create db:schema:load"
    SOLR_CORE_NAME: "starlight-test"
    SOLR_CONFIG_DIR: "starlight/solr/config"
    SOLR_CONFIG_COMMIT_SHA: $CI_COMMIT_SHA
    SOLR_URL: "http://solr:8983/solr/starlight-test"
    REPOSITORY_URL: $CI_REPOSITORY_URL
    RAILS_ENV: "test"
  services:
    - name: $CI_REGISTRY_IMAGE/solr
      alias: solr
    - postgres:11-alpine
  script:
    - cd starlight
    - RAILS_ENV=test bundle exec rspec --tag ~type:system --format progress --format RspecJunitFormatter --out rspec.xml
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    reports:
      junit: starlight/rspec.xml
    when: on_failure
  extends: .only-refs-default
  only:
    changes:
      - .gitlab-ci.yml
      - ci/starlight/**/*
      - starlight/**/*

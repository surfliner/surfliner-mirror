comet:test:unit:
  stage: test
  image: $CI_REGISTRY_IMAGE/comet_web:$CI_COMMIT_SHA
  needs: ["comet:ruby-build"]
  services:
    - name: bitnami/postgresql:12.6.0
      alias: postgres
    - name: bitnami/redis:6.2
      alias: redis
    - name: bitnami/solr:8
      alias: solr
    - name: bitnami/zookeeper:3
      alias: zk
  variables:
    DATABASE_URL: "postgres://postgres:postgres@localhost/comet-test"
    POSTGRES_DB: "comet-test"
    POSTGRES_PASSWORD: "postgres"
    POSTGRES_USER: "postgres"
    RAILS_ENV: "test"
    RAILS_QUEUE: "inline"
    REDIS_HOST: "redis"
    REDIS_PASSWORD: "redispass"
    SOLR_ADMIN_USER: admin
    SOLR_ADMIN_PASS: admin
    SOLR_ADMIN_PASSWORD: admin
    SOLR_CLOUD_BOOTSTRAP: "yes"
    SOLR_COLLECTION_NAME: comet-test
    SOLR_ENABLE_AUTHENTICATION: "yes"
    SOLR_ENABLE_CLOUD_MODE: "yes"
    SOLR_HOST: solr
    SOLR_PORT: 8983
    SOLR_ZK_HOSTS: zk:2181
  before_script:
    - >-
      solrcloud-upload-configset.sh /app/samvera/hyrax-webapp/solr/conf
      solrcloud-assign-configset.sh
  script:
    - cd /app/samvera/hyrax-webapp
    - bundle check || bundle
    - rake db:create db:migrate
    - bundle exec rspec
  extends:
    - .only-refs-default
    - .only-comet-changes
  allow_failure: true
  tags:
    - kubernetes

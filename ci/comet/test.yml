comet:test:unit:
  stage: test
  image: $CI_REGISTRY_IMAGE/comet_web:$CI_COMMIT_SHA
  needs: ["comet:ruby-build"]
  services:
    - name: bitnami/postgresql:12.6.0
      alias: postgres
  variables:
    DATABASE_URL: "postgres://postgres:postgres@localhost/comet-test"
    POSTGRES_DB: "comet-test"
    POSTGRES_PASSWORD: "postgres"
    POSTGRES_USER: "postgres"
    RAILS_ENV: "test"
    RAILS_QUEUE: "inline"
  script:
    - cd /app/samvera/hyrax-webapp
    - bundle check || bundle
    - rake db:create db:migrate
    - bundle exec rspec
  extends:
    - .only-refs-default
    - .only-comet-changes
  tags:
    - kubernetes


.comet:test:
  stage: test
  image: $CI_REGISTRY_IMAGE/comet_web:$CI_COMMIT_SHA
  needs: ["comet:build:app"]
  variables:
    AUTH_METHOD: "developer"
    CAPYBARA_PORT: 3010
    DATABASE_URL: "postgres://postgres:postgres@localhost/comet-test"
    DISCOVER_PLATFORM_TIDEWATER_URL_BASE: "http://localhost:3000/tidewater/item?source_iri="
    METADATA_API_URL_BASE: "http://localhost:3000/concern/generic_objects"
    POSTGRES_DB: "comet-test"
    POSTGRES_PASSWORD: "postgres"
    POSTGRES_USER: "postgres"
    RABBITMQ_ENABLED: "false"
    RABBITMQ_TOPIC: "surfliner.metadata"
    RABBITMQ_HOST: "rabbitmq"
    RABBITMQ_PASSWORD: "bitnami"
    RABBITMQ_USERNAME: "user"
    RABBITMQ_NODE_PORT_NUMBER: "5672"
    RAILS_ENV: "test"
    RAILS_QUEUE: "inline"
    REDIS_HOST: "redis"
    REDIS_PASSWORD: "redispass"
    SOLR_ADMIN_PASSWORD: "admin"
    SOLR_ADMIN_USER: "admin"
    SOLR_COLLECTION_NAME: comet-test
    SOLR_CORES: comet-test
    SOLR_CORE_CONF_DIR: "/surfliner-conf/comet/solr"
    SOLR_ENABLE_AUTHENTICATION: "yes"
    SOLR_HOST: solr
    SOLR_PORT: 8983
  before_script:
    - cd /app/samvera/hyrax-webapp
    - bundle check || bundle
    - RABBITMQ_ENABLED=0 db-wait.sh "${SOLR_HOST}:${SOLR_PORT}" rake db:create db:migrate
  rules:
    - !reference [.comet-mr-rules, rules]
    - !reference [.comet-default-branch-rules, rules]
  tags:
    - kubernetes

comet:test:unit:
  extends: .comet:test
  services:
    - name: bitnami/postgresql:12.10.0
      alias: postgres
    - name: bitnami/redis:6.2
      alias: redis
    - name: bitnami/solr:8.11.1
      alias: solr
  script:
    - bundle exec rspec --tag ~type:system --tag ~rabbitmq

comet:test:system:
  extends: .comet:test
  variables:
    AUTH_METHOD: "developer"
    HUB_URL: "http://localhost:4444/wd/hub/"
    MINIO_ACCESS_KEY: "minio-access-key"
    MINIO_DEFAULT_BUCKETS: "comet-test-bucket,comet-staging-area-test"
    MINIO_ENDPOINT: "minio"
    MINIO_SECRET_KEY: "minio-secret-key"
    RABBITMQ_ENABLED: "true"
    RABBITMQ_TOPIC: "surfliner.metadata"
    RABBITMQ_HOST: "rabbitmq"
    RABBITMQ_PASSWORD: "bitnami"
    RABBITMQ_USERNAME: "user"
    RABBITMQ_NODE_PORT_NUMBER: "5672"
    REPOSITORY_S3_BUCKET: "comet-test-bucket"
    STAGING_AREA_S3_BUCKET: "comet-staging-area-test"
  services:
    - name: bitnami/postgresql:12.10.0
      alias: postgres
    - name: bitnami/solr:8.11.1
      alias: solr
    - name: bitnami/redis:6.2
      alias: redis
    - name: bitnami/minio:2021-debian-10
      alias: minio
    - name: bitnami/rabbitmq:3.9.13-debian-10-r29
      alias: rabbitmq
    - name: selenium/standalone-chrome:98.0
      alias: chrome
  script:
    - >
      if ./scripts/rabbitmq-wait; then
        bundle exec rspec --tag type:system
      fi

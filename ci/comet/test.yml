comet:test:solrconfig:
  image: alpine:3.16.0
  stage: test
  needs: []
  rules:
    - !reference [.comet-mr-rules, rules]
    - !reference [.comet-default-branch-rules, rules]
  script:
    - tar -zcf comet-solr-config.tar.gz comet/solr
  artifacts:
    untracked: false
    expire_in: 1 day
    paths:
      - comet-solr-config.tar.gz

.comet:test:
  stage: test
  image: $CI_REGISTRY_IMAGE/comet_test:$CI_COMMIT_SHA
  needs: ["comet:test:solrconfig", "comet:build:test"]
  variables:
    AUTH_METHOD: "developer"
    CAPYBARA_PORT: 3010
    DATABASE_URL: "postgres://postgres:postgres@localhost/comet-test"
    DISCOVER_PLATFORM_TIDEWATER_URL_BASE: "http://localhost:3000/tidewater/item?source_iri="
    METADATA_API_URL_BASE: "http://localhost:3000/concern/generic_objects"
    POSTGRES_DB: "comet-test"
    POSTGRES_PASSWORD: "postgres"
    POSTGRES_USER: "postgres"
    RABBITMQ_ENABLED: "false"
    RABBITMQ_HOST: "rabbitmq"
    RABBITMQ_NODE_PORT_NUMBER: "5672"
    RABBITMQ_PASSWORD: "bitnami"
    RABBITMQ_TOPIC: "surfliner.metadata"
    RABBITMQ_USERNAME: "user"
    RAILS_ENV: "test"
    RAILS_QUEUE: "inline"
    REDIS_HOST: "redis"
    REDIS_PASSWORD: "redispass"
    SOLR_COLLECTION_NAME: comet-test
    SOLR_CORE_CONF_DIR: "/tmp/comet/solr/conf"
    SOLR_CORES: comet-test
    SOLR_HOST: solr
    SOLR_PORT: 8983

  before_script:
    - cd /app/samvera/hyrax-webapp
    - RABBITMQ_ENABLED=0 db-wait.sh "${SOLR_HOST}:${SOLR_PORT}" rake db:create db:migrate
  rules:
    - !reference [.comet-mr-rules, rules]
    - !reference [.comet-default-branch-rules, rules]
  tags:
    - kubernetes

comet:test:unit:
  extends: .comet:test
  services:
    - name: bitnami/postgresql:12.10.0
      alias: postgres
    - name: bitnami/redis:6.2
      alias: redis
    - name: bitnami/solr:8.11.1
      alias: solr
      entrypoint: [""]
      command:
        - /bin/sh
        - -c
        - >-
          curl -s -L --output /tmp/jq "https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64";
          chmod +x /tmp/jq;
          job_id=$(curl -s --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs?scope[]=success" | /tmp/jq '.[] | select(.name == "comet:test:solrconfig").id');
          curl -s --location --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/jobs/${job_id}/artifacts/comet-solr-config.tar.gz" | tar -xzv -C /tmp;
          /opt/bitnami/scripts/solr/entrypoint.sh /opt/bitnami/scripts/solr/run.sh;
  script:
    - bundle exec rspec --tag ~type:system --tag ~rabbitmq

comet:test:system:
  extends: .comet:test
  variables:
    AUTH_METHOD: "developer"
    HUB_URL: "http://localhost:4444/wd/hub/"
    LOG_LEVEL: "ERROR"
    MINIO_ACCESS_KEY: "minio-access-key"
    MINIO_DEFAULT_BUCKETS: "comet-test-bucket,comet-staging-area-test"
    MINIO_ENDPOINT: "minio"
    MINIO_SECRET_KEY: "minio-secret-key"
    RABBITMQ_ENABLED: "true"
    RABBITMQ_TOPIC: "surfliner.metadata"
    RABBITMQ_HOST: "rabbitmq"
    RABBITMQ_PASSWORD: "bitnami"
    RABBITMQ_USERNAME: "user"
    RABBITMQ_NODE_PORT_NUMBER: "5672"
    RAILS_LOG_TO_STDOUT: "false"
    REPOSITORY_S3_BUCKET: "comet-test-bucket"
    STAGING_AREA_S3_BUCKET: "comet-staging-area-test"
  services:
    - name: bitnami/postgresql:12.10.0
      alias: postgres
    - name: bitnami/solr:8.11.1
      alias: solr
      entrypoint: [""]
      command:
        - /bin/sh
        - -c
        - >-
          curl -s -L --output /tmp/jq "https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64";
          chmod +x /tmp/jq;
          job_id=$(curl -s --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs?scope[]=success" | /tmp/jq '.[] | select(.name == "comet:test:solrconfig").id');
          curl -s --location --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/jobs/${job_id}/artifacts/comet-solr-config.tar.gz" | tar -xzv -C /tmp;
          /opt/bitnami/scripts/solr/entrypoint.sh /opt/bitnami/scripts/solr/run.sh;
    - name: bitnami/redis:6.2
      alias: redis
    - name: bitnami/minio:2021-debian-10
      alias: minio
    - name: bitnami/rabbitmq:3.9.16-debian-10-r0
      alias: rabbitmq
    - name: seleniarm/standalone-chromium:102.0-20220602
      alias: chrome
      variables:
        SE_START_XVFB: "false"
  script:
    - >
      if ./scripts/rabbitmq-wait; then
        bundle exec rspec --tag type:system
      else
        echo "Timed out waiting for rabbitmq connection"
        exit 1
      fi

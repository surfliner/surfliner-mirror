.shoreline_builder: &shoreline_builder |
  set -x
  build_shoreline() {
    image_name=$1
    target=$2

    destination="--destination $CI_REGISTRY_IMAGE/$image_name:$CI_COMMIT_SHA"
    if [ "$CI_COMMIT_BRANCH" = "trunk" ]; then
      destination="$destination --destination $CI_REGISTRY_IMAGE/$image_name:stable"
    elif [ "$CI_COMMIT_TAG" ]; then
      destination="$destination --destination $CI_REGISTRY_IMAGE/$image_name:$CI_COMMIT_TAG"
    fi

    /kaniko/executor --context "$CI_PROJECT_DIR" --cache=true --push-retry 3 --target "$target" --dockerfile "$CI_PROJECT_DIR"/shoreline/Dockerfile $destination --build-arg LOCAL_PROJECT=shoreline --build-arg BUILD_TIME_APKS="$APKS"
  }

.shoreline:build:
  extends:
    - .kaniko-build
    - .only-refs-default
    - .only-shoreline-changes
  needs: ["shared:ruby-base"]
  variables:
    APKS: "build-base libxml2-dev libxslt-dev nodejs postgresql-dev shared-mime-info yarn"
  before_script:
    - *shoreline_builder

shoreline:build:prod:
  extends:
    - .shoreline:build
  script:
    - build_shoreline "shoreline" "shoreline-prod"

shoreline:build:test:
  extends:
    - .shoreline:build
  script:
    - build_shoreline "shoreline_test" "shoreline-dev"

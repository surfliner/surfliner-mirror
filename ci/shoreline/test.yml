shoreline:test:solrconfig:
  image: alpine:3.16.0
  stage: test
  needs: []
  extends:
    - .only-refs-default
    - .only-shoreline-changes
  before_script:
    - apk add tar
  script:
    - tar -zcf shoreline-solr-config.tar.gz shoreline/solr
  artifacts:
    untracked: false
    expire_in: 1 day
    paths:
      - shoreline-solr-config.tar.gz

.shoreline:test:
  stage: test
  image: $CI_REGISTRY_IMAGE/shoreline_test:$CI_COMMIT_SHA
  needs: ["shoreline:test:solrconfig", "shoreline:build:test"]
  variables:
    DATABASE_COMMAND: "db:schema:load"
    DELIVERY_METHOD: "test"
    POSTGRES_DB: "shoreline-discovery"
    POSTGRES_HOST: "postgres"
    POSTGRES_PASSWORD: "postgres"
    POSTGRES_PORT: 5432
    POSTGRES_USER: "postgres"
    RAILS_ENV: "test"
    SOLR_CORES: shoreline-discovery
    SOLR_CORE_CONF_DIR: /tmp/shoreline/solr/conf
    SOLR_HOST: solr
    SOLR_PORT: 8983
    SOLR_URL: "http://solr:8983/solr/shoreline-discovery"
  services:
    - name: bitnami/postgresql:12.11.0-debian-11-r15
      alias: postgres
    - name: bitnami/solr:8.11.2-debian-11-r6
      alias: solr
      entrypoint: [""]
      variables:
        JQ_VERSION: "jq-1.6"
      command:
        - /bin/sh
        - -c
        - >-
          curl -v -L --output /tmp/jq "https://github.com/stedolan/jq/releases/download/$JQ_VERSION/jq-linux64";
          chmod +x /tmp/jq;
          job_id=$(curl -s --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs?scope[]=success" | /tmp/jq '.[] | select(.name == "shoreline:test:solrconfig").id');
          echo "JOB ID for solrconfig is $job_id";
          echo curl --location -v --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/jobs/${job_id}/artifacts/shoreline-solr-config.tar.gz";
          curl -v --location --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/jobs/${job_id}/artifacts/shoreline-solr-config.tar.gz" | tar -xzv -C /tmp;
          /opt/bitnami/scripts/solr/entrypoint.sh /opt/bitnami/scripts/solr/run.sh;
  before_script:
    - cd /home/shoreline/app
    - solr-core-wait.sh
    - db-setup.sh
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    reports:
      junit: shoreline/rspec.xml
    when: on_failure
  extends:
    - .only-refs-default
    - .only-shoreline-changes
  tags:
    - kubernetes

shoreline:test:unit:
  extends: .shoreline:test
  script:
    - bundle exec rspec --tag ~type:feature --format progress --format RspecJunitFormatter --out rspec.xml

shoreline:test:feature:
  extends: .shoreline:test
  script:
    - bundle exec rspec --tag type:feature --format progress --format RspecJunitFormatter --out rspec.xml

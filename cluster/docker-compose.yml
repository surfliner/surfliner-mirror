services:
  comet:
    extends:
      file: ../docker-compose/comet.yaml
      service: comet
    env_file:
      - .env
    depends_on:
      - chrome
      - comet_migrate
      - memcached
      - minio
      - postgres
      - rabbitmq
      - redis
      - solr
    volumes:
      - hyrax-derivatives:/app/samvera/hyrax-webapp/derivatives
      - hyrax-uploads:/app/samvera/hyrax-webapp/uploads
      - rails-public:/app/samvera/hyrax-webapp/public
      - hyrax-scripts:/app/samvera/hyrax-webapp/scripts
    networks:
      - cluster

  superskunk:
    extends:
      file: ../docker-compose/superskunk.yaml
      service: superskunk
    env_file:
      - .env
      - superskunk.env
    volumes:
      - superskunk_tmp:/home/superskunk/app/tmp
    depends_on:
      - superskunk_migrate
      - postgres
    networks:
      - cluster

  cantaloupe:
    extends:
      file: ../docker-compose/orange-empire.yaml
      service: cantaloupe
    env_file:
      - .env
    depends_on:
      - minio
    networks:
      - cluster

  sidekiq:
    extends:
      file: ../docker-compose/comet.yaml
      service: sidekiq
    env_file:
      - .env
    depends_on:
      - comet_migrate
      - minio
      - memcached
      - postgres
      - redis
      - solr
      - rabbitmq
    volumes:
      - hyrax-derivatives:/app/samvera/hyrax-webapp/derivatives
      - hyrax-uploads:/app/samvera/hyrax-webapp/uploads
      - sidekiq-public:/app/samvera/hyrax-webapp/public
      - sidekiq-tmp:/app/samvera/hyrax-webapp/tmp
    networks:
      - cluster

  comet_migrate:
    extends:
      file: ../docker-compose/comet.yaml
      service: migrate
    env_file:
      - .env
    # this has to be set locally or it is overridden by .env
    # https://docs.docker.com/compose/extends/#adding-and-overriding-configuration
    environment:
      - RABBITMQ_ENABLED=false
    depends_on:
      - postgres
    volumes:
      - rails-public:/app/samvera/hyrax-webapp/public
      - rails-tmp:/app/samvera/hyrax-webapp/tmp
      - hyrax-scripts:/app/samvera/hyrax-webapp/scripts
    networks:
      - cluster

  superskunk_migrate:
    extends:
      file: ../docker-compose/superskunk.yaml
      service: migrate
    env_file:
      - .env
      - superskunk.env
    networks:
      - cluster

  rabbitmq:
    extends:
      file: ../docker-compose/common.yaml
      service: rabbitmq
    networks:
      - cluster

  chrome:
    extends:
      file: ../docker-compose/common.yaml
      service: chrome
    networks:
      - cluster

  postgres:
    extends:
      file: ../docker-compose/common.yaml
      service: postgres
    env_file:
      - .env
    volumes:
      - db:/bitnami/postgresql
    networks:
      - cluster

  memcached:
    extends:
      file: ../docker-compose/common.yaml
      service: memcached
    networks:
      - cluster

  minio:
    extends:
      file: ../docker-compose/common.yaml
      service: minio
    env_file:
      - .env
    volumes:
      - minio_data:/data
    networks:
      - cluster

  redis:
    extends:
      file: ../docker-compose/common.yaml
      service: redis
    env_file:
      - .env
    volumes:
      - redis:/bitnami/redis
    networks:
      - cluster

  solr:
    extends:
      file: ../docker-compose/common.yaml
      service: solr
    env_file:
      - .env
    volumes:
      - ../comet/solr/conf:/opt/comet
      - solr_home:/bitnami/solr
    networks:
      - cluster

volumes:
  db:
  hyrax-derivatives:
  hyrax-scripts:
  hyrax-uploads:
  minio_data:
  rails-public:
  rails-tmp:
  redis:
  sidekiq-public:
  sidekiq-tmp:
  solr_home:
  superskunk_tmp:

networks:
  cluster:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-cluster

stages:
  - maintanence
  - build
  - lint
  - test
  - integration
  - review
  - staging
  - production
  - cleanup
  - failure_notification

include:
  - local: ci/base.yml
  - local: ci/lark.yml
  - local: ci/shoreline.yml
  - local: ci/starlight.yml

# Build with Kaniko. When building on `master`, tag a new stable image.
.build_helpers: &build_helpers |
  set -x
  build_image_for() {
    if test $# -ne 2 ; then
        echo "You must specify a project path to a Dockerfile and an image name. example: build_image_for 'starlight' 'starlight_web'"
      exit 1
    fi
    project=$1
    image_name=$2
    destination="--destination $CI_REGISTRY_IMAGE/$image_name:$CI_COMMIT_SHA"
    if [ "$CI_COMMIT_BRANCH" = "master" ]; then
      destination="$destination --destination $CI_REGISTRY_IMAGE/$image_name:stable"
    fi
    /kaniko/executor --context "$CI_PROJECT_DIR"/$project --cache=true --dockerfile "$CI_PROJECT_DIR"/"$project"/Dockerfile $destination
  }


# Use Kaniko for building container images
.kaniko-build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug-v0.22.0
    entrypoint: [""]
  before_script:
    - *build_helpers
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json


# Surfliner-specific helm chart setup to include additional helm repos
.deploy_helpers: &deploy_helpers |
  [[ "$TRACE" ]] && set -x
  function build_chart_dependencies() {
    helm init --client-only

    helm repo add incubator https://kubernetes-charts-incubator.storage.googleapis.com/
    helm repo add bitnami https://charts.bitnami.com/bitnami

    helm dependency update chart/
    helm dependency build chart/
  }

# Gitlab image used for deployment
# see: https://gitlab.com/gitlab-org/gitlab-ce/blob/master/lib/gitlab/ci/templates/Jobs/Deploy.gitlab-ci.yml
.auto-deploy:
  image: "registry.gitlab.com/gitlab-org/cluster-integration/auto-deploy-image:v0.1.0"
  except:
    variables:
      - $NO_DEPLOY == "true"
  before_script:
    - *deploy_helpers

# Default only -> refs settings for all jobs
# see: https://docs.gitlab.com/ee/ci/yaml/#onlyrefsexceptrefs
.only-refs-default:
  only:
    refs:
      - master
      - merge_requests
      - tags

stages:
  - maintanence
  - build
  - lint
  - test
  - integration
  - review
  - staging
  - cleanup

include:
  - local: ci/base/maintanence.yml
  - local: ci/lark/build.yml
  - local: ci/lark/lint.yml
  - local: ci/lark/test.yml
  - local: ci/lark/review.yml
  - local: ci/lark/staging.yml
  - local: ci/shoreline/build.yml
  - local: ci/shoreline/lint.yml
  - local: ci/shoreline/test.yml
  - local: ci/shoreline/staging.yml
  - local: ci/starlight/build.yml
  - local: ci/starlight/lint.yml
  - local: ci/starlight/test.yml

# Surfliner-specific helm chart setup to include additional helm repos
.deploy_helpers: &deploy_helpers |
  [[ "$TRACE" ]] && set -x
  function build_chart_dependencies() {
    helm init --client-only

    helm repo add lib-helm-repo https://lib-helm-repo.ucsd.edu/
    helm repo add incubator https://kubernetes-charts-incubator.storage.googleapis.com/

    helm dependency update chart/
    helm dependency build chart/
  }

# Gitlab image used for deployment
# see: https://gitlab.com/gitlab-org/gitlab-ce/blob/master/lib/gitlab/ci/templates/Jobs/Deploy.gitlab-ci.yml
.auto-deploy:
  image: "registry.gitlab.com/gitlab-org/cluster-integration/auto-deploy-image:v0.1.0"
  except:
    variables:
      - $NO_DEPLOY == "true"
  before_script:
    - *deploy_helpers

# Default only -> refs settings for all jobs
# see: https://docs.gitlab.com/ee/ci/yaml/#onlyrefsexceptrefs
.only-refs-default:
  only:
    refs:
      - master
      - merge_requests
      - tags

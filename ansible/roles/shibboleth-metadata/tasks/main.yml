---
- name: ensure Shibboleth is running
  systemd:
    daemon_reload: yes
    enabled: yes
    name: shibd
    state: restarted
  become: yes

- name: Verify Shibboleth.sso/Metadata
  uri:
    url: 'http://localhost/Shibboleth.sso/Metadata'
    return_content: true
    validate_certs: false
  register: metadata

- name: write metadata
  copy:
    content: "{{ metadata.content }}"
    dest: /home/{{ deploy_user }}/shibboleth-{{ project_name }}.xml
    force: yes
    group: "{{ deploy_group }}"
    owner: "{{ deploy_user }}"

- name: notify writeout
  debug:
    msg: "Shibboleth metadata written to /home/{{ deploy_user }}/shibboleth-{{ project_name }}.xml"

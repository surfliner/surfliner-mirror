---
- name: get user UID
  shell: id -u {{ deploy_user }} | tr -d '\n'
  register: uid
  become: yes

- name: get user GID
  shell: id -g {{ deploy_user }} | tr -d '\n'
  register: gid
  become: yes

- name: create mount points
  file:
    path: "{{ item['mount_point'] }}"
    state: directory
  with_items: "{{ fs }}"
  become: yes

- name: write mount configuration
  lineinfile:
    create: yes
    dest: /etc/fstab
    group: root
    mode: 0600
    owner: root
    line: "{{ item['server'] }} \
           {{ item['mount_point'] }} \
           {{ item['fs_type'] }} \
           {{ item['mount_opts'] }},\
           uid={{ uid }},\
           gid={{ gid }},\
           credentials=/etc/{{ item['fs_user'] }}.mount 0 0"
  with_items: "{{ fs }}"
  become: yes

- name: write mount credentials
  copy:
    content: "username={{ item['fs_user'] }}\n\
              password={{ item['fs_password'] }}"
    dest: "/etc/{{ project_name }}.mount"
    owner: root
    group: root
    mode: 0600
  with_items: "{{ fs }}"
  become: yes

- name: mount new volumes
  command: mount -a
  become: yes

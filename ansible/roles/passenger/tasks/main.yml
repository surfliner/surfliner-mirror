---
# adapted from
# https://github.com/akishin/ansible-playbooks/blob/master/lokka/roles/passenger/tasks/main.yml

- name: install Ruby dependencies
  gem:
    name: "{{ item }}"
    state: present
    executable: "{{ ruby_bin_root }}/gem"
    user_install: false
  with_items:
    - bundler
    - rack
  become: yes
  when: not ansible_check_mode

- name: install Passenger
  gem:
    name: passenger
    state: present
    version: "{{ passenger_ver }}"
    executable: "{{ ruby_bin_root }}/gem"
    user_install: false
  become: yes
  when: not ansible_check_mode

- name: install passenger-install-apache2-module
  command: "{{ ruby_bin_root }}/passenger-install-apache2-module --auto --languages ruby"
  args:
    creates: "/usr/local/rbenv/versions/{{ ruby_ver }}/lib/ruby/gems/{{ ruby_abi }}/gems/passenger-{{ passenger_ver }}/buildout/apache2/mod_passenger.so"
  become: yes

- name: generate passenger.conf for Apache
  command: "{{ ruby_bin_root }}/passenger-install-apache2-module --snippet"
  register: passenger_conf
  changed_when: no

- name: write passenger.conf
  copy:
    content: "{{ passenger_conf.stdout }}"
    dest: /etc/httpd/conf.d/passenger.conf
  become: yes
  when: not ansible_check_mode
  notify: restart Apache

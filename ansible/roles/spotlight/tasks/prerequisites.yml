---
- name: download NodeSource repo
  get_url:
    url: https://rpm.nodesource.com/pub_{{ node_major_ver }}.x/el/7/x86_64/{{ item.rpm }}-{{ node_ver }}-1nodesource.x86_64.rpm
    checksum: sha256:{{ item.sha }}
    dest: /tmp/{{ item.rpm }}-{{ node_ver }}-1nodesource.x86_64.rpm
  with_items:
    '{{ node_rpms }}'

- name: install NodeSource repo
  yum:
    name: /tmp/{{ item.rpm }}-{{ node_ver }}-1nodesource.x86_64.rpm
  with_items:
    '{{ node_rpms }}'
  when: not ansible_check_mode

- name: install Remi repo for redis
  yum:
    name: http://rpms.remirepo.net/enterprise/remi-release-7.rpm

- name: install redis from Remi repo
  yum:
    name: redis
    enablerepo: remi
    state: present
  ignore_errors: "{{ ansible_check_mode }}"

- name: update all yum packages
  yum:
    name: "*"
    state: latest
    update_cache: yes

- name: install dependencies
  yum:
    name: "{{ spotlight_rpms }}"
  ignore_errors: "{{ ansible_check_mode }}"

# See https://github.com/zzet/ansible-rbenv-role/issues/12
- name: install bundler
  command: "{{ ruby_bin_root }}/gem install --no-document {{ item }}"
  with_items:
    name: bundler

- name: install yarn
  npm:
    global: yes
    name: yarn
    state: latest
  when: not ansible_check_mode

- name: start Redis
  systemd:
    daemon_reload: true
    enabled: yes
    name: redis
    state: started
  become: yes

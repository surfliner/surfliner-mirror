---
- name: install systemd script for Sidekiq
  template:
    dest: /etc/systemd/system/sidekiq.service
    src: sidekiq.service.j2
  become: yes

- name: generate key base
  shell: openssl rand -base64 64 | sha256sum | tr -d '\n\ -'
  register: rando

- name: set rails secret key base
  set_fact:
    rails_secret_key_base: "{{ rando.stdout }}"

- name: write systemctl variables file
  template:
    src: systemctl-vars.j2
    dest: /home/{{ deploy_user }}/.systemctl-variables

- name: enable Sidekiq
  systemd:
    daemon_reload: true
    enabled: yes
    name: sidekiq
  become: yes

- name: allow Capistrano to restart Sidekiq
  template:
    src: sudoers-sidekiq.j2
    dest: /etc/sudoers.d/sidekiq
    mode: 0440
    validate: visudo -c -f %s

---
- name: Provision a RHEL/CentOS server for Spotlight/Starlight
  hosts: all
  environment:
    - http_proxy: "{{ proxy | default('') }}"
    - https_proxy: "{{ proxy | default('') }}"
    - no_proxy: "localhost,127.0.0.0"

  vars:
    # written to env vars file
    # fqdn: localhost
    # from_email: root@localhost

    deploy_user: "{{ ansible_user_id }}"
    deploy_group: "{{ ansible_user_id }}"

    project_base: /opt
    project_name: starlight
    app_root: "{{ project_base }}/{{ project_name }}/current"
    binary_root: "{{ project_base }}/ingest"

    ruby_bin_root: /usr/local/rbenv/shims
    ruby_abi: 2.6.0
    ruby_ver: 2.6.2
    rbenv:
      env: system
      # required
      version: v1.1.1
      default_ruby: "{{ ruby_ver }}"
      rubies:
        - version: "{{ ruby_ver }}"

    shibbolethsp_handlerssl: false
    shibbolethsp_cookieprops: http
    configurables:
      - hakatest

    solr_host: localhost
    solr_core: collection1

    # set in vault file
    # smtp_host:

    # can be google, shibboleth, or database
    auth_method: google

    db_host: localhost
    db_name: spotlight_db
    # set in vault file
    # db_pass:
    db_user: spotlight

    postgresql_databases:
      - name: "{{ db_name }}"
    postgresql_users:
      - name: "{{ db_user }}"
        db: "{{ db_name }}"
        password: "{{ db_pass }}"

  roles:
    - role: geerlingguy.postgresql
      become: yes
    - role: solr
    - role: zzet.rbenv
      rbenv_owner: root
      rbenv_group: root
    - role: cmprescott.xml
    - role: cscfi.shibboleth-sp
      become: yes
    - role: apache
    - role: passenger
    - role: spotlight
      become: yes
    - role: shibboleth-sso
      become: yes
    - role: shibboleth-metadata
    # - role: fstab
    # - role: environment-variables

---
- name: Provision a RHEL/CentOS server for Spotlight/Starlight
  hosts: all
  environment:
    - http_proxy: "{{ proxy | default('') }}"
    - https_proxy: "{{ proxy | default('') }}"
    - no_proxy: "localhost,127.0.0.0"

  pre_tasks:

    - name: Check for local pre tasks
      local_action:
        module: stat
        path: '{{ local_pre_tasks | default("local-pre-tasks.yml") }}'
        get_checksum: false
        get_mime: false
      become: false
      become_user: "{{ lookup('env','USER') }}"
      register: local_pre

    - name: Local Pre tasks
      include_tasks:
        file: '{{ local_pre_tasks | default("local-pre-tasks.yml") }}'
      when: local_pre.stat.exists


    - name: geerlingguy.postgresql
      include_role:
        name: geerlingguy.postgresql
      vars:
        ansible_become: true
      when: db_host == 'localhost' and not ansible_check_mode

    - name: zzet.rbenv
      include_role:
        name: zzet.rbenv
      vars:
        rbenv_owner: root
        rbenv_group: root
      when: not ansible_check_mode

  roles:
    - role: solr
    - role: apache
    - role: passenger
    - role: spotlight
      become: yes

  tasks:
    - name: XML Module to support Ansible Tower
      include_role:
        name: cmprescott.xml
      when: ansible_version.full is version_compare("2.4", "<")

    - name: Check for local post tasks
      local_action:
        module: stat
        path: '{{ local_post_tasks | default("local-post-tasks.yml") }}'
        get_checksum: false
        get_mime: false
      become: false
      become_user: "{{ lookup('env','USER') }}"
      register: local_post

    - name: Local Post tasks
      include_tasks:
        file: '{{ local_post_tasks | default("local-post-tasks.yml") }}'
      when: local_post.stat.exists
